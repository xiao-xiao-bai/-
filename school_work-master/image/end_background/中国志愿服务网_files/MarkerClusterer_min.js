var BMapLib=(window.BMapLib=BMapLib||{});(function(){var h=function(a,b,d){b=m(b);var g=a.pointToPixel(b.getNorthEast());var e=a.pointToPixel(b.getSouthWest());g.x+=d;g.y-=d;e.x-=d;e.y+=d;var f=a.pixelToPoint(g);var c=a.pixelToPoint(e);return new BMap.Bounds(c,f);};var m=function(d){var b=k(d.getNorthEast().lng,-180,180);
var e=k(d.getSouthWest().lng,-180,180);var c=k(d.getNorthEast().lat,-74,74);var a=k(d.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(e,a),new BMap.Point(b,c));};var k=function(b,a,c){a&&(b=Math.max(b,a));c&&(b=Math.min(b,c));return b;};var i=function(a){return"[object Array]"===Object.prototype.toString.call(a);
};var n=function(a,e){var c=-1;if(i(e)){if(e.indexOf){c=e.indexOf(a);}else{for(var b=0,d;(d=e[b]);b++){if(d===a){c=b;break;}}}}return c;};var l=(BMapLib.MarkerClusterer=function(a,e){if(!a){return;}this._map=a;this._markers=[];this._clusters=[];var b=e||{};this._gridSize=b.gridSize||60;this._maxZoom=b.maxZoom||18;
this._minClusterSize=b.minClusterSize||2;this._isAverageCenter=false;if(b.isAverageCenter!=undefined){this._isAverageCenter=b.isAverageCenter;}this._styles=b.styles||[];var c=this;this._map.addEventListener("zoomend",function(){c._redraw();});this._map.addEventListener("moveend",function(){c._redraw();
});var d=b.markers;i(d)&&this.addMarkers(d);});l.prototype.addMarkers=function(a){for(var b=0,c=a.length;b<c;b++){this._pushMarkerTo(a[b]);}this._createClusters();};l.prototype._pushMarkerTo=function(b){var a=n(b,this._markers);if(a===-1){b.isInCluster=false;this._markers.push(b);}};l.prototype.addMarker=function(a){this._pushMarkerTo(a);
this._createClusters();};l.prototype._createClusters=function(){var c=this._map.getBounds();var a=h(this._map,c,this._gridSize);for(var b=0,d;(d=this._markers[b]);b++){if(!d.isInCluster&&a.containsPoint(d.getPosition())){this._addToClosestCluster(d);}}};l.prototype._addToClosestCluster=function(b){var f=4000000;
var q=null;var c=b.getPosition();for(var a=0,d;(d=this._clusters[a]);a++){var e=d.getCenter();if(e){var g=this._map.getDistance(e,b.getPosition());if(g<f){f=g;q=d;}}}if(q&&q.isMarkerInClusterBounds(b)){q.addMarker(b);}else{var d=new j(this);d.addMarker(b);this._clusters.push(d);}};l.prototype._clearLastClusters=function(){for(var a=0,b;
(b=this._clusters[a]);a++){b.remove();}this._clusters=[];this._removeMarkersFromCluster();};l.prototype._removeMarkersFromCluster=function(){for(var a=0,b;(b=this._markers[a]);a++){b.isInCluster=false;}};l.prototype._removeMarkersFromMap=function(){for(var a=0,b;(b=this._markers[a]);a++){b.isInCluster=false;
this._map.removeOverlay(b);}};l.prototype._removeMarker=function(b){var a=n(b,this._markers);if(a===-1){return false;}this._map.removeOverlay(b);this._markers.splice(a,1);return true;};l.prototype.removeMarker=function(b){var a=this._removeMarker(b);if(a){this._clearLastClusters();this._createClusters();
}return a;};l.prototype.removeMarkers=function(a){var b=false;for(var d=0;d<a.length;d++){var c=this._removeMarker(a[d]);b=b||c;}if(b){this._clearLastClusters();this._createClusters();}return b;};l.prototype.clearMarkers=function(){this._clearLastClusters();this._removeMarkersFromMap();this._markers=[];
};l.prototype._redraw=function(){this._clearLastClusters();this._createClusters();};l.prototype.getGridSize=function(){return this._gridSize;};l.prototype.setGridSize=function(a){this._gridSize=a;this._redraw();};l.prototype.getMaxZoom=function(){return this._maxZoom;};l.prototype.setMaxZoom=function(a){this._maxZoom=a;
this._redraw();};l.prototype.getStyles=function(){return this._styles;};l.prototype.setStyles=function(a){this._styles=a;this._redraw();};l.prototype.getMinClusterSize=function(){return this._minClusterSize;};l.prototype.setMinClusterSize=function(a){this._minClusterSize=a;this._redraw();};l.prototype.isAverageCenter=function(){return this._isAverageCenter;
};l.prototype.getMap=function(){return this._map;};l.prototype.getMarkers=function(){return this._markers;};l.prototype.getClustersCount=function(){var a=0;for(var b=0,c;(c=this._clusters[b]);b++){c.isReal()&&a++;}return a;};function j(a){this._markerClusterer=a;this._map=a.getMap();this._minClusterSize=a.getMinClusterSize();
this._isAverageCenter=a.isAverageCenter();this._center=null;this._markers=[];this._gridBounds=null;this._isReal=false;this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()});}j.prototype.addMarker=function(b){if(this.isMarkerInCluster(b)){return false;
}if(!this._center){this._center=b.getPosition();this.updateGridBounds();}else{if(this._isAverageCenter){var c=this._markers.length+1;var e=(this._center.lat*(c-1)+b.getPosition().lat)/c;var a=(this._center.lng*(c-1)+b.getPosition().lng)/c;this._center=new BMap.Point(a,e);this.updateGridBounds();}}b.isInCluster=true;
this._markers.push(b);var d=this._markers.length;if(d<this._minClusterSize){this._map.addOverlay(b);return true;}else{if(d===this._minClusterSize){for(var f=0;f<d;f++){this._markers[f].getMap()&&this._map.removeOverlay(this._markers[f]);}}}this._map.addOverlay(this._clusterMarker);this._isReal=true;this.updateClusterMarker();
return true;};j.prototype.isMarkerInCluster=function(b){if(this._markers.indexOf){return this._markers.indexOf(b)!=-1;}else{for(var a=0,c;(c=this._markers[a]);a++){if(c===b){return true;}}}return false;};j.prototype.isMarkerInClusterBounds=function(a){return this._gridBounds.containsPoint(a.getPosition());
};j.prototype.isReal=function(a){return this._isReal;};j.prototype.updateGridBounds=function(){var a=new BMap.Bounds(this._center,this._center);this._gridBounds=h(this._map,a,this._markerClusterer.getGridSize());};j.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);
for(var a=0,c;(c=this._markers[a]);a++){this._map.addOverlay(c);}return;}if(this._markers.length<this._minClusterSize){this._clusterMarker.hide();return;}this._clusterMarker.setPosition(this._center);this._clusterMarker.setText(this._markers.length);var b=this._map;var d=this.getBounds();this._clusterMarker.addEventListener("click",function(e){b.setViewport(d);
});};j.prototype.remove=function(){for(var a=0,b;(b=this._markers[a]);a++){this._markers[a].getMap()&&this._map.removeOverlay(this._markers[a]);}this._map.removeOverlay(this._clusterMarker);this._markers.length=0;delete this._markers;};j.prototype.getBounds=function(){var a=new BMap.Bounds(this._center,this._center);
for(var b=0,c;(c=this._markers[b]);b++){a.extend(c.getPosition());}return a;};j.prototype.getCenter=function(){return this._center;};})();